---
title: "Mortality predictors"
author: "Sergey Vladimirov"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: readable
    fig_width: 11
  pdf_document: default
  word_document: default
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
)

#install.packages("stargazer")
#install.packages('blorr')

library(blorr)
library(stargazer)

library(tidyverse)
library(magrittr)
library(hms)
library(RSQLite)
library(DBI)
library(kableExtra)
library(ggsci)
library(patchwork)
library(tufte)
library(ggthemes)
library(ggplot2)
library(finalfit)
library(lubridate)
library(janitor)
library(readxl)
library(readr)
library(hrbrthemes)
library(flextable)
library(gtsummary)
#install.packages('pROC')
library(pROC)
library(GGally)
#install.packages('DiagrammeR')
library(DiagrammeR)
#install.packages('sjPlot')
library(sjPlot)

```

```{r echo=FALSE, include = FALSE }
#  Importing and fixing final dataset

original_data <- read_csv('final_project_df.csv')


original_data <- original_data %>%
  mutate_if(is.character, as.factor) %>%
  mutate(neutropenia = as.factor(neutropenia)) %>% 
   mutate(
    resp_insuf = as.factor(case_when(
      sofa_resp > 0 ~ 1,
      sofa_resp < 1 ~ 0
    )),
    neur_def = as.factor(case_when(
      sofa_gcs > 0 ~ 1,
      sofa_gcs < 1 ~ 0
    )),
    hep_insuf = as.factor(case_when(
      sofa_bil > 0 ~ 1,
      sofa_bil < 1 ~ 0
    )),
    hemod_instab = as.factor(case_when(
      sofa_map > 0 ~ 1,
      sofa_map < 1 ~ 0
    )),
    thrombocytopenia = as.factor(case_when(
      sofa_plt > 0 ~ 1,
      sofa_plt < 1 ~ 0
    )),
    renal_insuf = as.factor(case_when(
      sofa_renal > 0 ~ 1,
      sofa_renal < 1 ~ 0
    ))
    ) %>% 
  select(id, gender, age, cci, diagnosis,
         disease_status, days_bfr_icu, 
         sofa, neutropenia, is_deceased)


```

# Abstract

Despite progress in therapeutic options and improved prognosis of
hematological patients in recent years, the mortality of patients with
hematological malignancies (HM) requiring admission to intensive care
units (ICU) remains high. According to the results of the latest
observational research, the factors of poor outcome in such patients
vary. I am going to identify prognostic factors associated with the ICU
and hospital mortality in the cohort of HM patients who were admitted to
ICU in my hospital between April 2022 and April 2023. My dataset
contains 43 variables of 69 consecutive critically ill patients. The
following parameters were recorded within 24 h of ICU admission:
demographic data, diagnosis, some major laboratory data, values of
severity scales (SOFA and SAPS), indicators of vital functions. Three
columns contain information about outcomes (dead_icu - outcome of ICU
case, dead_hospital - outcome of overall hospitalization, icu_los -
length of stay in ICU). I am planning to perform a regression analysis
in order to reveal some meaningful factors related to ICU and hospital
mortality in these patients. Source of data: electronic health records.

# Introduction

## Background:

*Provide an overview of the research topic and explain its importance or
personal interest.*

## Objectives:

*State the research question and the specific objectives of the study.*

Are there any factors in conditions of hematology patients, admitting to
ICU, that can predict a lethal outcome?

## Hypothesis:

*Formulate a testable hypothesis based on the research question.*

In patients with HM, admitted to ICU, are there any factors that can
predict lethal outcome?

# Methods

## Data/Population/Variables:

*List and define the variables that were measured in the study,
including any independent, dependent, or confounding variables.*

```{r echo=FALSE}

df_variable <- colnames(original_data)

var_definition <- c(
  "anonymized identical number of patient",
  "gender of patient",
  "age of patient",
  "Charlson Comorbidity Index - most widely used scoring system for comorbidities",
  "type of hematological malignancy",
  "status of HM progression",
  "number of days in hospital before admission to ICU",
  "sequential organ failure assessment score (SOFA score), is used  to determine the extent of organ function or rate of failure",
  "absolute neutrophil count < 1000/mm3",
  "outcome (1 is death, 0 is survival)")

var_type <- c(
  "numerical",
  "categorical, binary",
  "numerical, years",
  "numerical, points",
  "categorical",
  "categorical: p (progression) - relapsed or refractory disease, n - newly diagnosed",
  "numerical, days",
  "numerical, points",
  "categorical, binary (1 = yes, 0 = no)",
  "categorical, binary (1 is death, 0 is survival)")



var_status <-  c(
  "independent",
  "independent",
  "independent",
  "independent",
  "independent",
  "independent",
  "independent",
  "independent",
  "independent",
  "dependent")
  
var_df <-  
bind_cols(df_variable, var_definition, var_type, var_status) %>% 
  rename( variable = '...1', definition = '...2', type = '...3', status = '...4')


var_df %>% flextable() %>% 
  theme_box() %>% 
  set_caption('A list of variables used in analysis')

#knitr::kable(
#  var_df, "simple", caption = 'A list of variables used in analysis'
#)

```

## Study design:

Describe the (assumed) study design, including the type of study (e.g.,
observational, experimental), the population or sample size.

We performed an observational study

```{r}
grViz("                           # All instructions are within a large character string
digraph surveillance_diagram {    # 'digraph' means 'directional graph', then the graph name 
  
  # graph statement
  #################
  graph [layout = dot,
         rankdir = TB,
         overlap = true, 
         fontsize = 10]
  
  # nodes
  #######
  node [shape = rectangle,           # shape = rectangle
       fixedsize = false
       width = 1.3,               # width of circles
       fontsize = 10]
  Primary [label = '127 patients were evaluated']                     # names of nodes
  Secondary [label = '99 patients were included'] 
  Dead [label = '51 patients died']
  Alive [label = '47 patients survived']

  # edges
  #######
  Primary   -> Secondary [label = '14 cases were exluded due to missed data
  8 were transferred to the wards within 24h
  7 died within 24h', fontsize = 8] 
  Secondary -> Dead
  Secondary -> Alive
}
")
```


## Statistical analysis:

Describe the statistical methods used to analyze the data, including any
descriptive statistics, inferential statistics, or regression analysis.
Provide an explanation why the chosen methods suit the study objectives.

# Results

## Descriptive statistics:

*Present the descriptive statistics for each variable, including measures
of central tendency (e.g., mean, median), variability (e.g., standard
deviation, range), and distribution (e.g., normality),...*

Need to remember package with histograms in descriptive table

```{r}


original_data %>% 
  select(gender, age, cci, diagnosis,
         disease_status, days_bfr_icu, 
         sofa, neutropenia, is_deceased) %>% 
  tbl_summary(     
    by = is_deceased,     # stratify entire table by outcome
    type = all_continuous() ~ "continuous2",
    statistic = list(all_continuous() ~ c(
      "{mean} ({sd})",                             # line 1: mean and SD
      "{median} ({p25}, {p75})",                   # line 2: median and IQR
      "{min}, {max}"))) %>% 
      
  bold_labels() %>%
  modify_header(
    list(
      stat_1 ~ "**Survived**  \n N = {n}",
      stat_2 ~ "**Dead**  \n N = {n}")) %>%
  modify_footnote(update = everything() ~ NA) %>%
  add_overall() %>% 
  as_flex_table() %>%
  theme_box() 
 




```


## Inferential statistics:

Report the results of any inferential statistics tests performed, such
as t-tests, ANOVA, or chi-square tests + corresponding RxC tables.
Including the test statistics, degrees of freedom, p-values, and effect
sizes. Results of crude and stratified analysis if possible to stratify.

## Regression analysis:

*If regression analysis was performed, report the results of the
regression model, including the regression coefficients, standard
errors, and R-squared value, results for models adjusted for confounders
and crude,...*

Binary logistic regression is robust to many of the assumptions which cause problems in other statistical analyses. The main assumptions are:

Binary dependent variable - this is obvious, but as above we need to check (alive, death from disease, death from other causes doesn’t work);
Independence of observations - the observations should not be repeated measurements or matched data;
Linearity of continuous explanatory variables and the log-odds outcome - take age as an example. If the outcome, say death, gets more frequent or less frequent as age rises, the model will work well. However, say children and the elderly are at high risk of death, but those in middle years are not, then the relationship is not linear. Or more correctly, it is not monotonic, meaning that the response does not only go in one direction;
No multicollinearity - explanatory variables should not be highly correlated with each other.



### checking the linearity of continuous variables

A graphical check of linearity can be performed using a best fit “loess” line. This is on the probability scale, so it is not going to be straight. But it should be monotonic - it should only ever go up or down.

```{r}


original_data %>% 
  select(is_deceased, age, cci, sofa, days_bfr_icu) %>% 
  pivot_longer(all_of(c("age", "sofa", "sofa", "cci",
                        "days_bfr_icu")), names_to = "predictors") %>% 
  ggplot(aes(x = value, y = is_deceased)) + 
  geom_point(size = 0.5, alpha = 0.5) +
  geom_smooth(method = "loess") + 
  facet_wrap(~predictors, scales = "free_x")+
  labs ( title = "Fig.1  Checking numeric variables for linearity",
         subtitle = "All of the slopes are monotonic, i.e. linear")
  
```
### Checking for multicolinearity

```{r}
select_explanatory <- c("sofa", "cci")
original_data %>% 
  remove_labels() %>% 
  ggpairs(columns = select_explanatory)




```

Finally, as a final check for the presence of higher-order correlations, the variance inflation factor can be calculated for each of the terms in a final model. In simple language, this is a measure of how much the variance of a particular regression coefficient is increased due to the presence of multicollinearity in the model.

Here is an example. GVIF stands for generalised variance inflation factor. A common rule of thumb is that if this is greater than 5-10 for any variable, then multicollinearity may exist. The model should be further explored and the terms removed or reduced.

```{r}
dependent <- "is_deceased"
explanatory <- c("gender","cci", "sofa")
original_data %>% 
  glmmulti(dependent, explanatory) %>%
  car::vif() %>% 
  as.data.frame() %>%
  add_column(c("gender", "cci", "sofa")) %>% 
  rename(variable = 'c("gender", "cci", "sofa")', GVIF = ".") %>% 
  select(variable, everything()) %>% 
  flextable() %>% 
  set_caption(caption = "Generalised variance inflation factor (GVIF)")
  
```


```{r}

explanatory_vars <- c("gender", "age", "cci", "disease_status", "neutropenia",'days_bfr_icu', "sofa")
multi_vars <- c('gender', 'cci', 'sofa')
univ_tab <- original_data %>% 
  dplyr::select(all_of(explanatory_vars), is_deceased) %>% ## select variables of interest
 
  tbl_uvregression(                         ## produce univariate table
    method = glm,                           ## define regression want to run (generalised linear model)
    y = is_deceased,                            ## define outcome variable
    method.args = list(family = binomial),  ## define what type of glm want to run (logistic)
    exponentiate = TRUE                     ## exponentiate to produce odds ratios (rather than log odds)
  )

## view univariate results table 
univ_tab %>%
  bold_labels() %>% 
  as_flex_table() %>%
  theme_box() %>% 
  set_caption('Univariate analysis of factors')


mv_reg <- glm(is_deceased ~ sofa + cci + gender, family = "binomial", data = original_data)
tbl_regression(mv_reg, exponentiate = TRUE) -> multiv_tab



```

```{r}
library(finalfit)
dependent <- "is_deceased"
explanatory <-  c("gender", "age", "cci", "disease_status", "neutropenia",'days_bfr_icu', "sofa")
explanatory_multi = c("gender","sofa", "cci")
fit2 = original_data %>% 
  finalfit(dependent, explanatory_multi, metrics = TRUE)

original_data %>%
  summary_factorlist(dependent, explanatory, fit_id=TRUE) -> reg_summary

original_data %>%
  glmuni(dependent, explanatory) %>%
  fit2df(estimate_suffix=" (univariable)") -> uni_reg

original_data %>%
  glmmulti(dependent, explanatory_multi) %>%
  fit2df(estimate_suffix=" (multivariable)") -> multi_reg




reg_summary %>%
  finalfit_merge(uni_reg) %>%
  finalfit_merge(multi_reg, last_merge = TRUE)

mv_reg <- glm(is_deceased ~ sofa + cci + gender, family = "binomial", data = original_data)
tbl_regression(mv_reg, exponentiate = TRUE)

mv_reg %>% 
  broom::tidy(exponentiate = TRUE, conf.int = TRUE) %>%  ## get a tidy dataframe of estimates 
  mutate(across(where(is.numeric), round, digits = 2))  -> mv_reg_tab         ## round 
```

```{r}
# Basic Logistic Regression Commands
uni_object <-  glm(is_deceased ~ gender + age + sofa + cci +
                       disease_status + days_bfr_icu, data = original_data, family = "binomial")
object <- glm(is_deceased ~ gender + sofa + cci, data = original_data, family = "binomial")

# Model Fit Statistics

#blorr::blr_model_fit_stats(object)        # Gives various fit statistics
 # blorr::blr_test_hosmer_lemeshow(object)   # Hosmer Lemeshow gof test
blorr::blr_roc_curve(blr_gains_table(object), title = "ROC curve for the model, AUC = 0.74" ) # ROC curve
DescTools::Cstat(object)              # C-Statistic (concordance statistic)
  
sjPlot:: tab_model(object, 
                    show.intercept = FALSE,
                    show.aic = TRUE,
                    show.r2 = FALSE,
                    title = 'Results of multivariate analysis of factors') 


sjPlot:: tab_model(uni_object, 
                    show.intercept = FALSE,
                    show.aic = TRUE,
                    show.r2 = FALSE,
                    title = 'Results of univariate analysis of factors') 

sjPlot:: plot_model(type = "est", object, show.values = TRUE, width = 0.1,
                   axis.labels = "" , 
                   title = 'Odds ratio of ICU mortality, multivariate model',
                   axis.lim = c(0.99,10),
                   vline.color = 'red') +
  ylab("Odds ratio with confidence intervals")

sjPlot:: plot_model(type = "est", uni_object, show.values = TRUE, width = 0.1,
                   axis.labels = "" , 
                   title = 'Odds ratio of ICU mortality, univariate analysis',
                   axis.lim = c(0.2,10),
                   vline.color = 'red') +
  ylab("Odds ratio with confidence intervals")


```




```{r}
## remove the intercept term from your multivariable results
mv_reg_tab %>% 

  
  #set order of levels to appear along y-axis
#  mutate(term = fct_relevel(
#    term,
 #   "vomit", "gender", "fever", "cough", "chills", "aches",
#    "age_cat5-9", "age_cat10-14", "age_cat15-19", "age_cat20-29",
#   "age_cat30-49", "age_cat50-69", "age_cat70+")) %>%
  
  # remove "intercept" row from plot
  filter(term != "(Intercept)") %>% 
  
  ## plot with variable on the y axis and estimate (OR) on the x axis
  ggplot(aes(x = estimate, y = term)) +
  
  ## show the estimate as a point
  geom_point() + 
  
  ## add in an error bar for the confidence intervals
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high)) + 
  
  ## show where OR = 1 is for reference as a dashed line
  geom_vline(xintercept = 1, linetype = "dashed")
```


```{r}
mv_reg_tab %>% 
  filter(term != "(Intercept)") %>%
  mutate(term = fct_relevel(
    term,
    "gendermale", "sofa", "cci")) %>% 
  arrange(desc(estimate)) -> mv_reg_tab

## Create the table-base pallete


table_base <- ggplot(mv_reg_tab, aes(y=term)) +   
  ylab(NULL) + xlab("  ") + 
  theme(plot.title = element_text(hjust = 0.5, size=12), 
        axis.text.x = element_text(color="white", hjust = -3, size = 25), ## This is used to help with alignment
        axis.line = element_blank(),
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(),
        axis.title.y = element_blank(), 
        legend.position = "none",
        panel.background = element_blank(), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        plot.background = element_blank())

## OR point estimate table
tab1 <- table_base + 
  labs(title = "space") +
  geom_text(aes(y = term, x = 1, label = sprintf("%0.1f", round(estimate, digits = 1))), size = 4) + ## decimal places
  ggtitle("OR")




```
```{r}

explanatory = c("gender",  "cci", "sofa")
dependent = 'is_deceased'


original_data %>% 
   or_plot(dependent, explanatory, dependent_label = "ICU mortality")

#write.csv(original_data, 'final_report_df.csv')
```





# Discussion

## Interpretation:

Interpret the results of the study in light of the research question and
hypothesis.

## Comparison to prior research:

Compare the results of the study to prior research on the topic and
discuss any similarities, differences, or contradictions.

## Limitations:

Identify and discuss any limitations of the study, such as sample size,
measurement error, confounding variables, possible sources of bias. \##
Implications:

Discuss the implications of the findings for the field of biostatistics
and for future research (I know that it's kind of weird for a study
project, but you have to practice this skill of showing off).

# Conclusion

## Summary: Summarize the main findings of the study and the conclusions drawn from them.

## Recommendations:

Provide recommendations for future research on the topic, based on the
limitations and implications of the study.

# References

List all sources cited in the report, including any data sources,
statistical software packages used, and prior research studies.

# Appendices

## Raw data tables.

Maybe interesting figures, or graphs that are not fully related to the
project's main research question with their discussion.
